#!/bin/bash
#/**********************************************************************
# GP3ASM version
#axasm Copyright 2006, 2007, 2008, 2009 
#by Al Williams (alw@al-williams.com).
#
#
#This file is part of axasm.
#
#axasm is free software: you can redistribute it and/or modify it
#under the terms of the GNU General Public Licenses as published
#by the Free Software Foundation, either version 3 of the License, or
#(at your option) any later version.
#
#axasm is distributed in the hope that it will be useful, but
#WITHOUT ANY WARRANTY: without even the implied warranty of 
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the 
#GNU General Public License for more details.
#
#You should have received a copy of the GNU General Public License
#along with axasm (see LICENSE.TXT). 
#If not, see http://www.gnu.org/licenses/.
#
#If a non-GPL license is desired, contact the author.
#
#This is the assembler driver script
#
#***********************************************************************/

PROC=soloasm 
LIB=`dirname $0`



function usage {
  cat >&2 <<EOF
  Usage: gp3asm [-D define] [-o file] [-z zipfile] [-n name] inputfile
         -D = Set C-style preprocessor define (multiple allowed)
         -n = Set output name
         -o = Set output file (required)
         -z = Write zip file
  gp3asm, axasm and soloasm by Al Williams al.williams@awce.com
EOF
exit 1
}



POSTOP=""   # output arguments sent to compiled program
DEFOP=""    # -D options to compiler
ZIPFILE=0
while getopts  "hD:o:z:n:" flag
do
  case $flag in 
  D )  DEFOP="$DEFOP -D $OPTARG"  ;;
  n ) PNAME=$OPTARG ;;
  o ) OUTFILE=$OPTARG ;;
  z ) ZIPFILE=1 ; ZFILE=$OPTARG ;;
  h )  usage ;; 
  ? )  usage ;;
  esac
done
if [ -z "$OUTFILE" ]
then 
  usage
fi
PROC="gp3"
POSTOP="$POSTOP -v"
shift `expr $OPTIND - 1`

# test for $# >= 1
if [ $# -lt 1 ]
then usage
fi

LFILE=`mktemp`
CFILE=`mktemp`
XFILE=`mktemp`
rm -f $CFILE
awk -f $LIB/soloinc.awk $1 | awk -f $LIB/solopre.awk -v PROC=$PROC -v LFILE=$LFILE  >$CFILE
if gcc -I$LIB -x c -std=c99 $DEFOP -o $XFILE $LIB/soloasm.c $CFILE 
then
  if [ "$ZIPFILE" == "1" ] 
  then
  ZMNT=`mktemp -d`
  fuse-zip $ZFILE $ZMNT
  OUTFILE="$ZMNT/$OUTFILE"
  cp $1 $ZMNT/$PNAME.gpa
  fi
$XFILE $POSTOP | awk -f $LIB/gp3loader.awk >$OUTFILE
 if [ "$ZIPFILE" == "1" ] 
   then
   THEDATE=`date`
   cat >$ZMNT/readme.txt <<EOF
File $PNAME compiled with GP3ASM on $THEDATE
GP3ASM is a free service provided by AWC
User assumes all risk of using code generated by GP3ASM.
AWC provides the program and this output 'as is' without 
warranty of any kind, expressed or implied, including, 
but not limited to, the implied warranties of 
merchantability and fitness for a particular purpose.
EOF

   fusermount -u $ZMNT
   rm -r $ZMNT
   fi
fi
rm $LFILE
rm $CFILE
rm $XFILE

